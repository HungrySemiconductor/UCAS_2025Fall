# 协议与形式化描述与IPv6（1、2、8、9）

##### 1. 简述协议的三要素，并结合具体网络协议举例说明。

- **语法**: 指数据的结构与格式，解决“如何表示”的问题，确保通信双方对数据格式的一致解析

  例如，TCP头部中16位源端口、16位目的端口、32位序列号等字段的固定排列顺序和长度，即为语法。

- **语义**: 指数据字段的含义及对应的动作，解决“做什么”的问题，明确数据的用途（如请求 / 响应、连接建立 / 断开）  

  例如，TCP头部中的SYN标志位为1，语义是“发起连接请求”；ACK标志位为1，语义是“确认已收到数据”。

- **同步**: 指通信事件发生的顺序与时序关系，解决“何时做”的问题。避免数据错位或阻塞（如发送方过快，接收方处理不及）

  例如，TCP的三次握手（SYN -> SYN-ACK -> ACK）严格规定了连接建立的顺序和节奏，这就是同步。

- **老师强调**：这是必考基础概念，需清晰区分并能举例。

---

##### 2. 服务质量（QoS）与体验质量（QoE）的区别与主要指标

- **QoS 定义**：**协议提供的服务质量指标**（指IP分组或数据流通过网络时，网络所表现出来的、可测量的端到端性能特性，它决定了用户对服务的满意程度）
- **QoS 核心衡量指标**:
  1. **带宽**：信道具有的频带宽度，单位Hz
  2. **吞吐量**：单位时间内通过网络(或信道、 接口)的数据量  
  3. **传输速率**：每秒传输的二进制比特数，单位bps/s
  4. **时延**：分组的第一个bit离开发送端与分组的最后一个bit到达接收端的时间间隔  ，包括**发送时延、传播时延、处理时延、排队时延**。
  5. **时延抖动**：时延的变化程度，反映的是端到端延时的变化特性。 
  6. **分组丢失率**：单位时间内丢失分组数量与所传输的分组量的比值，取平均值
  7. **误码率**：二进制符号在传输系统中被传错的概率，接受的错误比特数与传输的总比特数之比
  8. **时延带宽积**： 传播时延 × 带宽。它表示链路上已发出但尚未到达接收端的比特数量，反映了链路的“管道容量”。
  9. **往返时间RTT**：从发送方发送数据开始，到发送方收到接收方确认所经历的总时间。RTT = 2 × 传播时延 + 接收端处理排队时延 + 接收端发送时延。
  10. **利用率**：不是越高越好
      1. **信道利用率**：信道的使用效率
      2. **网络利用率**：网络中全部信道的利用率的加权平均值
- **QoE 定义**：**用户对服务质量的感知与体验**（是指用户对业务的主观体验，是从用户的角度感觉到的系统的整体性能，是客户对服务商整体满意度的衡量）
- **QoE 关键性能指标**：可靠性（业务可达性、业务响应时间、业务中断率）、舒适度（业务质量QoS、业务易用性）

- **用户体验质量（QoE）与服务质量（QoS）的区别与联系**：

  - **QoS**：从**网络或业务的角度**体现服务质量
  - **QoE**：从**用户角度**对业务的主观体验

  - **QoS是QoE的基础和技术保障**。优异的网络层QoS（高带宽、低时延）是获得良好用户体验（QoE）的必要条件。
  - **QoE是QoS的最终体现和终极目标**。所有网络和协议优化的最终目的都是为了提升用户的QoE。

---

##### 3. **协议开发过程中，协议的表现形式有哪几种？请简要说明。**

1. **非形式描述文本**: 用自然语言和图表表达的初始协议规范，易理解但不精确。
2. **形式描述文本**: 用FDL（如基于FSM、**Petri网的语言**）描述的协议，抽象、精确，可进行形式化验证和自动转换。
3. **与机器无关的源代码**: 由形式描述文本通过翻译器生成的通用程序设计语言（如C）代码。
4. **协议实现代码**: 在上述代码基础上，加入与具体操作系统、硬件环境相关的代码（如内存管理、I/O操作）后形成的可执行产品。
5. **测试套件**: 由形式描述文本生成的、用于对协议实现进行一致性测试的一组测试程序和测试数据。

---

##### 4. Petri网理论

- **流的概念区分**

  - **Flow（网络流）**：具有同样的源IP地址、源端口号、目的IP地址、目的端口号、协议标识符、以及服务质量需求的一连串分组

    **Stream（数据流）**：指实际传输中的二进制数据序列

- **Petri网的定义**：Petri网用于描述和分析系统中的**控制流和信息流**， 尤其是那些有异步和并发活动的系统。由两种节点： 库所和变迁， 有向弧， 以及token等元素组成的。  
- **基本元素**:
  1. **库所 (Place)**：圆形节点。描述可能的系统的局部状态（条件、状态），例如队列、缓冲。资源等
  2. **变迁 (Transition)**：方形节点。描述修改系统状态的事件、动作，例如信息处理、发送、资源的存取等
  3. **有向弧 (Arc)**：连接库所和变迁，定义输入和输出关系。库所之间或变迁之间不能直接用弧相连（事件能够发生的局部条件状态；由事件所引发的局部状态的转换）
  4. **令牌 (Token)**：库所中的资源（黑点），可以从一个库所移动到另一个库所
- **点火规则**：
  
  1. **使能条件**：输入一个变迁的库所中的令牌数**大于等于**连接弧的权值（默认权值为1）
  2. **点火过程**：使能的变迁可以“点火”。点火后，从**每个输入库所**移走等于连接弧权值的令牌数，并向**每个输出库所**增加等于连接弧权值的令牌数
  3. **原子性**：点火操作是**原子**的，不可分割，输入清楚令牌就会有输出产生令牌

![image-20251224104743246](E:\Typora\Typora\coding-study\image-20251224104743246.png)

![image-20251224104846537](E:\Typora\Typora\coding-study\image-20251224104846537.png)

![image-20251224104855013](E:\Typora\Typora\coding-study\image-20251224104855013.png)

![image-20251224104900946](E:\Typora\Typora\coding-study\image-20251224104900946.png)

---

##### 5. 有限状态机

- 定义：一种软件设计模式，用于描述对象在它的生命周期内所经历的状态序列， 以及如何响应来自外界的各种事件
- ![image-20251226232024369](E:\Typora\Typora\coding-study\image-20251226232024369.png)![image-20251226232609322](E:\Typora\Typora\coding-study\image-20251226232609322.png)![image-20251226232629000](E:\Typora\Typora\coding-study\image-20251226232629000.png)

---

##### 6.IPv6地址分类

- **地址表示**
  
> IPv4（32bit）：二进制——>十进制

  - IPv6（128bit）：二进制——>十六进制
- IPv6地址 = 前缀（网络ID） + 接口标识（主机ID），前缀长度用 “/xx” 表示
  
- **::压缩与压缩前导**
  
  - 2001:0410:0000:0001:0000:0000:0000:45ff
  - 2001:410:0:1::45ff
  
- **IPv6地址分类：单播、组播、任播**

  > IPv4：单播（A、B、C类）、多播（D类）、保留（E类）、广播（255.255.255.255）

  - **单播地址**

    - 标识一个接口，送到被标识的接口，唯一不可重复，点对点通信

    | 单播种类                                                     | 地址前缀             | 说明                                                         | 备注                                              |
    | ------------------------------------------------------------ | -------------------- | ------------------------------------------------------------ | ------------------------------------------------- |
    | 全球单播地址<br>可聚合全球单播地址（可聚合：减少路由表表项） | 2000::/3             | 全球唯一，用于需要有互联网访问需求的主机，类似于IPv4的公网地址 | 范围2000-3FFF                                     |
    | 唯一本地地址（ULA）                                          | FD00::/8<br>FC00::/7 | ipv6的私网地址，只能在内网中使用，不是自动生成的，不对外转发 | 同一站点内网，可跨子网                            |
    | 链路本地地址（LLA）                                          | FE80::/10            | 每个ipv6接口都具备一个LLA，用于同一物理链路通信，路由器禁止转发（无状态地址自动配置、IPv6邻居发现<MAC地址>）<br>**地址生成**：<br>**1. 64bit 前缀**：FE80::/64<br>**2. 64bit 接口ID**：在48位MAC地址中间添加 **FF FE** ，然后**将第7位置反**，解决U/L位在两种协议中语义不一致的问题<br>（MAC：0全球管理地址，1本地管理地址；IPv6中相反） | 有效范围是本地链路，如单交换机下设备，不可跨子网  |
    | 未指定地址（默认地址）                                       | ::/128               | 临时作为特定报文的源地址（重复地址检测的邻居请求报文，DHCPc6初始化请求） | 作为DAD检测完成之前的源地址，不能作为有效地址使用 |
    | 环回地址                                                     | ::1/128              | 本地协议栈回环测试（对应IPv4的127.0.0.1）                    |                                                   |

  - **任播地址** 

    - 标识一组网络接口，仅作为目标地址
    - 路由器将目标地址是任播地址的数据报送到**最近的一个**被标识接口，最近节点由路由协议来定义
    - **与单播地址使用同一地址空间**，使用单播地址中的任何形式，即由路由器决定数据包是做任播转发还是单播转发**（区别于单播：不做唯一性检测，地址可以被多个端口共享）**
    - 使用 anycast 配置接口的任播地址
    - ![image-20251226212952944](E:\Typora\Typora\coding-study\image-20251226212952944.png)

  - **组播地址** 
    
    - **FF00::/8** 
    - 标识多个接口，送到**被标识的所有**接口，仅作为目的地址
    - 组播地地址中 **flags**（FF**X**0::1，即9-12bit）表示组播标识（0000永久，0001临时）
    - 组播地地址中 **scope**（FF0**X**::1，即13-16bit）表示组播的范围（节点1、链路2、站点5、组织8、全球范围E、0与F预留）
    - 邻居发现、重复地址检测

- 被请求接地点**组播地址**（Solicited-node）

  - 定义：当一个节点具备单播或任播地址，就会对应生成并加入一个被请求组播地址
  - 作用：主要用于邻居发现机制、地址重复检测、地址解析
  - 有效范围：本地链路范围
  - 地址组成：由前缀**FF02::1:FF00:0/104** 和 IPv6**单播地址（全球单播、唯一本地、链路本地）的后24位**组成

- ![image-20251229173216346](E:\Typora\Typora\coding-study\image-20251229173216346.png)

---

##### 7. IPv6报文结构

- **基本首部**（固定长度40bytes）

  - | 长度 bits | 内容         | 含义                                                         |
    | --------- | ------------ | ------------------------------------------------------------ |
    | 4         | 版本         | 协议版本，IPv6该字段为6                                      |
    | 8         | 通信量类     | 区分数据报不同类别/优先级<br>**字段值为：0-7 阻塞发生时允许延时处理<br>字段值为：8-15 为优先级较高的实时业务，需要用固定速率传输** |
    | 20        | 流标号       | 流：网络上从特定源点到特定终点的一系列数据报（实时数据流、视频音频流）<br>所有属于同一个流的数据报都具有同样的流标号，相同的流标签可进行同样的数据优先级设定 |
    | 16        | 有效载荷长度 | 除基本首部以外的字节数，最大值65536<br>**若长度超过65535，则将其置0，该字段用逐条选项扩展报头中的“超大有效载荷”选项来表示** |
    | 8         | 下一个首部   | 存在扩展报头：下一个扩展报头类型<br>不存在扩展报头：TCP(6)、UPD(7)、ICMPv6(58) |
    | 8         | 跳数限制     | 源站在数据报发出时设定的跳数限制<br>**每个路由器在转发数据报时将该字段值减1**<br>为0时，向源站发出“超时-跳数限制超时”的ICMPv6报文报告差错，并丢弃该数据报 |
    | 128       | 源地址       | 数据报的发送站的IP地址                                       |
    | 128       | 目的地址     | 数据报的接收站的IP地址（存在路由扩展报头，则为下一个转发路由器的地址） |

  - ![image-20251229171726675](E:\Typora\Typora\coding-study\image-20251229171726675.png)

- **扩展首部**

  >将原来 IPv4 首部中选项的功能都放在扩展首部中
  >
  > 并将扩展首部留给路径两端的源站和目的站的主机来处理，数据报途中经过的路由器都不处理这些扩展首部**（除逐跳选项扩展首部）**
  >
  >路由器也**不需重新计算校验和， 也不需做分片操作**，提高路由器的处理效率  

  ![image-20251229175643276](E:\Typora\Typora\coding-study\image-20251229175643276.png)

  ![image-20251229180201868](E:\Typora\Typora\coding-study\image-20251229180201868.png)

---

##### 8. NDP 邻居发现协议

- **ICMPv6协议**：NDP协议使用部分ICMPv6报文

  - 功能：错误报告、网络诊断

  - 分类：差错报文（报告分组传输过程中出现的错误）、信息报文（提供网络诊断功能和附加的主机功能）

  - 所有ICMPv6报文都是封装在IPv6分组中传送的

    ![image-20251229184413893](E:\Typora\Typora\coding-study\image-20251229184413893.png)

- **NDP功能**

  ![image-20251229181713460](E:\Typora\Typora\coding-study\image-20251229181713460.png)

- **主要考点**

  - 无状态地址配置
  - 地址重复检测
  - 地址解析

---

##### 9. IPv6地址自动配置方式（**全球单播地址**）

> IPv6数据报发送前的流程：
>
> **地址配置**（全球、链路）—>**DAD**（重复地址检测）—>**地址解析**（类似于ARP，IPv6地址与MAC地址映射关系）
>
> **链路本地地址**：当一个节点启动ipv6协议栈时，启动时节点的每个接口会自动配置一个链路本地地址，使得两个连接到同意链路的ipv6节点不需要做任何配置就可以通信
>
> **全球单播地址**：采用**手动/自动（有/无状态）**地址配置方式

- **有状态地址配置（DHCPv6）**配置过程：服务器统一分配，记录绑定关系
  
  1. 主机先自动生成链路本地地址
  2. 主机发送 RS，触发路由器发送 RA，主机获取RA消息，确认有状态配置指令
  3. DHCv6消息交互，以分配地址与配置
  4. 地址唯一性检测DAD
5. 配置应用（主机将分配的IPv6地址设备接口地址，同时应用DNS、NTP等配置）与地址续租

- **无状态地址自动配置（SLAAC）**配置过程：节点自动拼接
  1. 主机先自动生成链路本地地址
  2. 主机发送 RS，路由器回应 RA 到主机，包含了前缀信息（路由器前缀）、跳数（存活时间）、MTU
  3. 主机收到 RA，并发出 NS（新地址 = RA中**路由器的前缀** + 由主机MAC地址自动生成的**64位接口ID**【向48位MAC地址中插入FFFE】）
  4. 无 NA 响应，主机将使用该地址；有 NA 响应，主机将重新生成新地址，再次发出 NS

- **配置方式对比**

  ![image-20251229185149186](E:\Typora\Typora\coding-study\image-20251229185149186.png)



# 协议栈与协议实现（3、4、5、6、7）

### 🟢 第3章：网络协议体系架构与实现技术

**重点：理解“分层”与“实现”的逻辑**

- [x]  **OSI 与 TCP/IP 模型 (Page 6-12)**：掌握每一层的功能，尤其是网络层、传输层。
- [x]  **封装与解封装过程 (Page 15-20)**：理解数据包如何逐层加头。
- [x]  **协议实现方法 (Page 35-45)**：用户空间与内核空间实现协议栈的区别。

![image-20260101201919209](E:\Typora\Typora\coding-study\image-20260101201919209.png)

![image-20260101203648094](E:\Typora\Typora\coding-study\image-20260101203648094.png)

![image-20260101205905633](E:\Typora\Typora\coding-study\image-20260101205905633.png)

![image-20260101211613076](E:\Typora\Typora\coding-study\image-20260101211613076.png)

![image-20260101211720040](E:\Typora\Typora\coding-study\image-20260101211720040.png)

![image-20260101212116145](E:\Typora\Typora\coding-study\image-20260101212116145.png)

### 🟢 第4章：链路层协议原理与实现

**重点：内存对齐、字节序、ARP交互**

- [x] **内核协议架构 (Slide 10)**：理解应用程序、Socket、协议栈与驱动的关系。
- [x] **★内存对齐原理 (需重点查找相关页面)**：录音特意强调。理解结构体定义中 `__attribute__((packed))` 的作用，防止编译器自动填充字节导致协议头解析错误。
- [x]  **字节序转换 (Slide 15-20)**：大端（网络序）与小端（主机序）的转换原理。
- [x]  **以太网帧格式 (Slide 100-110)**：DIX Ethernet V2 标准各字段含义（目的MAC、源MAC、类型字段 0x0800/0x0806）。
- [x] **ARP协议原理 (Slide 127-134)**：ARP请求（广播）与响应（单播）的过程，ARP缓存表的作用。

![image-20260102115552364](E:\Typora\Typora\coding-study\image-20260102115552364.png)

![image-20260102122136650](E:\Typora\Typora\coding-study\image-20260102122136650.png)

![image-20260102124516271](E:\Typora\Typora\coding-study\image-20260102124516271.png)

![image-20260102133318522](E:\Typora\Typora\coding-study\image-20260102133318522.png)

![image-20260102134048076](E:\Typora\Typora\coding-study\image-20260102134048076.png)

![image-20260102135254303](E:\Typora\Typora\coding-study\image-20260102135254303.png)

![image-20260102140254145](E:\Typora\Typora\coding-study\image-20260102140254145.png)

### 🟢 第5章：IP和ICMP协议原理与实现

**重点：IPv4报文结构、ICMP类型、路由逻辑**

- [x] **★校验和 (Checksum) 原理**：掌握 16 位 Internet Checksum 的计算逻辑（反码求和）。

- [x]   **★IPv4首部格式 (Page 8-15)**：重点背诵 TTL（生存时间）、协议（TCP=6, UDP=17, ICMP=1）、首部校验和。
- [x]   **IP分片原理 (Page 25-30)**：理解 MTU 的限制以及分片字段（标识、标志、片偏移）。
- [x]   **ICMP协议原理 (Page 53-56)**：ICMP如何封装在IP包内。
- [x]   **★常见ICMP消息类型 (Page 64-69)**：
  - 类型 8/0：Ping 请求/回显。
  - 类型 3：终点不可达（重点看端口不可达 3/3）。
  - 类型 11：超时（用于 Traceroute）。
- [x]  **关注“承载关系”**：清楚 UDP/TCP 放在 IP 的 Data 部分，IP 放在以太网帧的 Data 部分。**ICMP虽然用IP承载，但其属于网络层！！！**
- [x]  ![image-20260102153257358](E:\Typora\Typora\coding-study\image-20260102153257358.png)

![image-20260102155015022](E:\Typora\Typora\coding-study\image-20260102155015022.png)

![image-20260102155025118](E:\Typora\Typora\coding-study\image-20260102155025118.png)

![image-20260102155043528](E:\Typora\Typora\coding-study\image-20260102155043528.png)

![image-20260102155055453](E:\Typora\Typora\coding-study\image-20260102155055453.png)

![image-20260102155105015](E:\Typora\Typora\coding-study\image-20260102155105015.png)

![image-20260102155115057](E:\Typora\Typora\coding-study\image-20260102155115057.png)

![image-20260102155632545](E:\Typora\Typora\coding-study\image-20260102155632545.png)

![image-20260102160819223](E:\Typora\Typora\coding-study\image-20260102160819223.png)

![image-20260102162058242](E:\Typora\Typora\coding-study\image-20260102162058242.png)

![image-20260102163415429](E:\Typora\Typora\coding-study\image-20260102163415429.png)

![image-20260102163513564](E:\Typora\Typora\coding-study\image-20260102163513564.png)

![image-20260102163742054](E:\Typora\Typora\coding-study\image-20260102163742054.png)

![image-20260102163750384](E:\Typora\Typora\coding-study\image-20260102163750384.png)

![image-20260102194305669](E:\Typora\Typora\coding-study\image-20260102194305669.png)

![image-20260102164734139](E:\Typora\Typora\coding-study\image-20260102164734139.png)

![image-20260102194712950](E:\Typora\Typora\coding-study\image-20260102194712950.png)

### 🟢 第6章：UDP协议原理与实现

**重点：复用与分用、UDP头部**

- [x]   **复用与分用 (Page 5-10)**：理解端口号如何区分不同的应用进程。
- [x]   **UDP首部格式 (Page 15-16)**：仅 8 字节，包含源/目的端口、长度、校验和。
- [x]   **UDP计算校验和**
- [x]   **UDP控制块与回调 (Page 35-40)**：理解协议栈如何通过端口查找对应的处理函数（录音提到的“实现的原理”）。

![image-20260101213418433](E:\Typora\Typora\coding-study\image-20260101213418433.png)

![image-20260102101031941](E:\Typora\Typora\coding-study\image-20260102101031941.png)

![image-20260102101315913](E:\Typora\Typora\coding-study\image-20260102101315913.png)

![image-20260101213948603](E:\Typora\Typora\coding-study\image-20260101213948603.png)

![image-20260102102218000](E:\Typora\Typora\coding-study\image-20260102102218000.png)

![image-20260102102542480](E:\Typora\Typora\coding-study\image-20260102102542480.png)

![image-20260102103017763](E:\Typora\Typora\coding-study\image-20260102103017763.png)

![image-20260102104103360](E:\Typora\Typora\coding-study\image-20260102104103360.png)

![image-20260102111254097](E:\Typora\Typora\coding-study\image-20260102111254097.png)

![image-20260102111455623](E:\Typora\Typora\coding-study\image-20260102111455623.png)

### 🟢 第7章：TCP协议原理与实现

**重点：三次握手/四次挥手、可靠传输、滑动窗口**

- [x]   **TCP主要特点 (Page 3-7)**：面向连接、可靠、全双工、面向字节流。
- [x]   **TCP报文段首部 (Page 15-22)**：重点掌握 Seq（序号）、Ack（确认号）、Flags（SYN/ACK/FIN/RST/PSH/URG）、Window（窗口大小）。
- [x]   **★三次握手 (Page 25-35)**：每一轮的 Seq 和 Ack 如何变化，状态如何转换（LISTEN -> SYN_RCVD -> ESTABLISHED）。
- [x]   **★四次挥手 (Page 40-45)**：为什么需要四次，TIME_WAIT 状态的作用。
- [x]   **滑动窗口与流量控制 (Page 50-65)**：理解发送窗口与接收窗口的关系。
- [x]   **拥塞控制 (Page 125-140)**：慢开始、拥塞避免、快重传、快恢复四个阶段的基本逻辑。

![image-20260102204216925](E:\Typora\Typora\coding-study\image-20260102204216925.png)

![image-20260103215906494](E:\Typora\Typora\coding-study\image-20260103215906494.png)![image-20260103220712762](E:\Typora\Typora\coding-study\image-20260103220712762.png)

![image-20260103221332100](E:\Typora\Typora\coding-study\image-20260103221332100.png)